@page "/stations"
@using fs_2025_assessment_1_73599_blazorapp.Models
@using fs_2025_assessment_1_73599_blazorapp.Services
@rendermode InteractiveServer
@inject StationsApiClient ApiClient
@inject NavigationManager Navigation

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5">Dublin Bike Stations</h1>
            <p class="text-muted">Browse and manage bike stations across Dublin</p>
        </div>
        <div class="col-md-4 text-end d-flex align-items-end justify-content-end">
            <button class="btn btn-success me-2" @onclick="NavigateToCreate">
                <span class="oi oi-plus"></span> Create New
            </button>
            <button class="btn btn-primary" @onclick="RefreshStations">
                <span class="oi oi-reload"></span> Refresh
            </button>
        </div>
    </div>

    <!-- Filters Component -->
    <StationFilters @bind-SearchTerm="searchTerm"
                    @bind-SelectedStatus="selectedStatus"
                    @bind-MinBikesFilter="minBikesFilter"
                    @bind-SortBy="sortBy"
                    @bind-SortDirection="sortDirection"
                    OnFiltersApplied="ApplyFilters" />

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="alert alert-info" role="alert">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Loading stations...
        </div>
    }

    <!-- Error State -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Stations Table -->
    @if (!isLoading && stations.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Station Name</th>
                        <th scope="col">Address</th>
                        <th scope="col">Status</th>
                        <th scope="col">Bikes Available</th>
                        <th scope="col">Total Stands</th>
                        <th scope="col">Occupancy</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var station in stations)
                    {
                        <tr>
                            <td>
                                <strong>@station.name</strong>
                            </td>
                            <td>
                                <small class="text-muted">@station.address</small>
                            </td>
                            <td>
                                @if (station.status == "OPEN")
                                {
                                    <span class="badge bg-success">OPEN</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">CLOSED</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">@station.available_bikes</span>
                            </td>
                            <td>
                                @station.bike_stands
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar"
                                         role="progressbar"
                                         style="width: @(station.OccupancyPercentage)%"
                                         aria-valuenow="@station.OccupancyPercentage"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        @station.OccupancyPercentage%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" @onclick="() => ViewDetails(station.number)">
                                    View
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                        Previous
                    </button>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    int pageNum = i;
                    <li class="page-item @(currentPage == pageNum ? "active" : "")">
                        <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                        Next
                    </button>
                </li>
            </ul>
        </nav>

        <!-- Results Info -->
        <div class="text-center text-muted mt-3">
            <small>Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalStations) of @totalStations stations</small>
        </div>
    }

    <!-- Empty State -->
    @if (!isLoading && stations.Count == 0)
    {
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">No stations found</h4>
            <p>
                @if (HasActiveFilters())
                {
                    <span>No stations match your current filters. Try adjusting your search criteria.</span>
                }
                else
                {
                    <span>There are currently no bike stations available. Please try again later.</span>
                }
            </p>
        </div>
    }
</div>

@code {
    private List<Station> stations = new();
    private bool isLoading = true;
    private string errorMessage = "";
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalStations = 0;
    private int totalPages = 0;

    // Filter state
    private string searchTerm = "";
    private string selectedStatus = "";
    private int minBikesFilter = 0;
    private string sortBy = "";
    private string sortDirection = "asc";

    protected override async Task OnInitializedAsync()
    {
        await LoadStations();
    }

    private async Task LoadStations()
    {
        try
        {
            isLoading = true;
            errorMessage = "";

            var response = await ApiClient.GetStationsAsync(
                currentPage,
                pageSize,
                searchTerm,
                selectedStatus,
                minBikesFilter,
                sortBy,
                sortDirection);

            stations = response.data;
            totalStations = response.total;
            totalPages = (int)Math.Ceiling((double)totalStations / pageSize);

            if (stations.Count == 0 && !HasActiveFilters() && response.total == 0)
            {
                errorMessage = "No stations found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load stations: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GoToPage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= totalPages)
        {
            currentPage = pageNumber;
            await LoadStations();
        }
    }

    private async Task RefreshStations()
    {
        currentPage = 1;
        await LoadStations();
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadStations();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(searchTerm) ||
               !string.IsNullOrEmpty(selectedStatus) ||
               minBikesFilter > 0;
    }

    private void ViewDetails(int stationNumber)
    {
        Console.WriteLine($"[VIEW] Navigating to station detail page: {stationNumber}");
        Navigation.NavigateTo($"/stations/{stationNumber}");
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/stations/create");
    }
}
