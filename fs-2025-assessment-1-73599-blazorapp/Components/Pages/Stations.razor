@page "/stations"
@using fs_2025_assessment_1_73599_blazorapp.Models
@using fs_2025_assessment_1_73599_blazorapp.Services
@rendermode InteractiveServer
@inject StationsApiClient ApiClient

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5">Dublin Bike Stations</h1>
            <p class="text-muted">Browse and manage bike stations across Dublin</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" @onclick="RefreshStations">
                <span class="oi oi-reload"></span> Refresh
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none" type="button" @onclick="ToggleFilters">
                    <span class="@(showFilters ? "oi oi-chevron-bottom" : "oi oi-chevron-right")"></span>
                    Filters & Search
                </button>
            </h5>
        </div>

        @if (showFilters)
        {
            <div class="card-body">
                <div class="row g-3">
                    <!-- Search Box -->
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search by Name or Address</label>
                        <input type="text"
                               class="form-control"
                               id="searchInput"
                               placeholder="Enter station name or address..."
                               @bind="searchTerm"
                               @onkeyup="OnSearchChanged" />
                    </div>

                    <!-- Status Filter -->
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" @onchange="HandleStatusChange">
                            <option value="">All Stations</option>
                            <option value="OPEN">Open</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                    </div>

                    <!-- Minimum Bikes Filter -->
                    <div class="col-md-3">
                        <label for="minBikesInput" class="form-label">Minimum Available Bikes</label>
                        <input type="number"
                               class="form-control"
                               id="minBikesInput"
                               min="0"
                               placeholder="0"
                               @onchange="HandleMinBikesChange" />
                    </div>

                    <!-- Sort Control -->
                    <div class="col-md-2">
                        <label for="sortSelect" class="form-label">Sort By</label>
                        <select class="form-select" id="sortSelect" @onchange="HandleSortChange">
                            <option value="">None</option>
                            <option value="name">Name</option>
                            <option value="availablebikes">Available Bikes</option>
                            <option value="occupancy">Occupancy</option>
                        </select>
                    </div>

                    <!-- Sort Direction -->
                    <div class="col-md-2">
                        <label for="sortDir" class="form-label">Direction</label>
                        <select class="form-select" id="sortDir" @onchange="HandleSortDirectionChange">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>

                    <!-- Clear Filters Button -->
                    <div class="col-12">
                        <button class="btn btn-secondary" @onclick="ClearFilters">
                            <span class="oi oi-x"></span> Clear All Filters
                        </button>
                    </div>
                </div>

                <!-- Active Filters Display -->
                @if (HasActiveFilters())
                {
                    <div class="mt-3">
                        <p class="text-muted mb-2"><strong>Active Filters:</strong></p>
                        <div class="d-flex flex-wrap gap-2">
                            @if (!string.IsNullOrEmpty(searchTerm))
                            {
                                <span class="badge bg-info">
                                    Search: @searchTerm
                                    <button class="btn-close btn-close-white ms-1" @onclick="() => ClearSearch()" style="font-size: 0.7rem;"></button>
                                </span>
                            }

                            @if (!string.IsNullOrEmpty(selectedStatus))
                            {
                                <span class="badge bg-info">
                                    Status: @selectedStatus
                                    <button class="btn-close btn-close-white ms-1" @onclick="() => ClearStatus()" style="font-size: 0.7rem;"></button>
                                </span>
                            }

                            @if (minBikesFilter > 0)
                            {
                                <span class="badge bg-info">
                                    Min Bikes: @minBikesFilter
                                    <button class="btn-close btn-close-white ms-1" @onclick="() => ClearMinBikes()" style="font-size: 0.7rem;"></button>
                                </span>
                            }

                            @if (!string.IsNullOrEmpty(sortBy))
                            {
                                <span class="badge bg-info">
                                    Sort: @sortBy (@sortDirection)
                                    <button class="btn-close btn-close-white ms-1" @onclick="() => ClearSort()" style="font-size: 0.7rem;"></button>
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="alert alert-info" role="alert">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Loading stations...
        </div>
    }

    <!-- Error State -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Stations Table -->
    @if (!isLoading && stations.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Station Name</th>
                        <th scope="col">Address</th>
                        <th scope="col">Status</th>
                        <th scope="col">Bikes Available</th>
                        <th scope="col">Total Stands</th>
                        <th scope="col">Occupancy</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var station in stations)
                    {
                        <tr>
                            <td>
                                <strong>@station.name</strong>
                            </td>
                            <td>
                                <small class="text-muted">@station.address</small>
                            </td>
                            <td>
                                @if (station.status == "OPEN")
                                {
                                    <span class="badge bg-success">OPEN</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">CLOSED</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">@station.available_bikes</span>
                            </td>
                            <td>
                                @station.bike_stands
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar"
                                         role="progressbar"
                                         style="width: @(station.OccupancyPercentage)%"
                                         aria-valuenow="@station.OccupancyPercentage"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        @station.OccupancyPercentage%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" @onclick="() => ViewDetails(station.number)">
                                    View
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                        Previous
                    </button>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    int pageNum = i;
                    <li class="page-item @(currentPage == pageNum ? "active" : "")">
                        <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                        Next
                    </button>
                </li>
            </ul>
        </nav>

        <!-- Results Info -->
        <div class="text-center text-muted mt-3">
            <small>Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalStations) of @totalStations stations</small>
        </div>
    }

    <!-- Empty State -->
    @if (!isLoading && stations.Count == 0)
    {
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">No stations found</h4>
            <p>
                @if (HasActiveFilters())
                {
                    <span>No stations match your current filters. Try adjusting your search criteria.</span>
                }
                else
                {
                    <span>There are currently no bike stations available. Please try again later.</span>
                }
            </p>
        </div>
    }
</div>

@code {
    private List<Station> stations = new();
    private bool isLoading = true;
    private string errorMessage = "";
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalStations = 0;
    private int totalPages = 0;

    // Filter state
    private string searchTerm = "";
    private string selectedStatus = "";
    private int minBikesFilter = 0;
    private string sortBy = "";
    private string sortDirection = "asc";
    private bool showFilters = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStations();
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
        StateHasChanged();
    }

    private async Task LoadStations()
    {
        try
        {
            isLoading = true;
            errorMessage = "";

            var response = await ApiClient.GetStationsAsync(
                currentPage,
                pageSize,
                searchTerm,
                selectedStatus,
                minBikesFilter,
                sortBy,
                sortDirection);

            stations = response.data;
            totalStations = response.total;
            totalPages = (int)Math.Ceiling((double)totalStations / pageSize);

            if (stations.Count == 0 && !HasActiveFilters() && response.total == 0)
            {
                errorMessage = "No stations found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load stations: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GoToPage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= totalPages)
        {
            currentPage = pageNumber;
            await LoadStations();
        }
    }

    private async Task RefreshStations()
    {
        currentPage = 1;
        await LoadStations();
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadStations();
    }

    private async Task HandleStatusChange(ChangeEventArgs e)
    {
        selectedStatus = e.Value?.ToString() ?? "";
        await ApplyFilters();
    }

    private async Task HandleMinBikesChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            minBikesFilter = value;
        }
        else
        {
            minBikesFilter = 0;
        }
        await ApplyFilters();
    }

    private async Task HandleSortChange(ChangeEventArgs e)
    {
        sortBy = e.Value?.ToString() ?? "";
        await ApplyFilters();
    }

    private async Task HandleSortDirectionChange(ChangeEventArgs e)
    {
        sortDirection = e.Value?.ToString() ?? "asc";
        await ApplyFilters();
    }

    private async Task OnSearchChanged(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadStations();
        }
    }

    private async Task ClearFilters()
    {
        searchTerm = "";
        selectedStatus = "";
        minBikesFilter = 0;
        sortBy = "";
        sortDirection = "asc";
        currentPage = 1;
        await LoadStations();
    }

    private async Task ClearSearch()
    {
        searchTerm = "";
        await ApplyFilters();
    }

    private async Task ClearStatus()
    {
        selectedStatus = "";
        await ApplyFilters();
    }

    private async Task ClearMinBikes()
    {
        minBikesFilter = 0;
        await ApplyFilters();
    }

    private async Task ClearSort()
    {
        sortBy = "";
        await ApplyFilters();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(searchTerm) ||
               !string.IsNullOrEmpty(selectedStatus) ||
               minBikesFilter > 0;
    }

    private void ViewDetails(int stationNumber)
    {
        Console.WriteLine($"View details for station {stationNumber}");
    }
}
